const {Server,ServerEvent}=require('./lib/server'),WebSocket=require('ws'),fetch=require('node-fetch'),wanakana=require('wanakana'),fs=require('fs'),fsPromises=require('fs')['promises'],JSON5=require('json5'),getPort=require('get-port'),{Client}=require('ssh2'),net=require('net'),express=require('express'),http=require('http'),path=require('path'),configCandidates=['./config.json5','./config.jsonc','./config.json'];let config={},configLoaded=![],configPath='';for(const filePath of configCandidates){if(fs['existsSync'](filePath))try{const fileContent=fs['readFileSync'](filePath,'utf8');config=JSON5['parse'](fileContent),configLoaded=!![],configPath=filePath;break;}catch(q){console['error']('[Config]\x20Error\x20parsing\x20'+filePath+':',q['message']);}}!configLoaded&&console['warn']('[Config]\x20No\x20configuration\x20file\x20found.\x20Using\x20default\x20settings.');let {app_id='',secret_key='',username='',sub_domain='',sub_domain2='',ssh_password='',port=0x4abc,web_port=0x1f40,proximity=!![],spectator=!![],specListen=!![],specDim=![],password=![],verify,distance=0x6,lang='en'}=config;password=verify??password;let roomId=sub_domain,stop_roop=![],passwords={},positions={},yRots={},dimensions={},shouldBroadcast=!![],vc_connected=![],mc_connected=![],isWebSocketConnected=![],isHttpConnected=![],wss,relayWs,mainWorld,vcSSHClient,mcSSHClient,spectators={},useRelay=![],streamlit=![],useResetTimer=![];const onlinePlayers=new Set(),nameCache=new Map(),server_log_info=J=>console['log']('\x1b[36m[Info]\x1b[0m\x20'+J),server_log_log=J=>console['log']('\x1b[33m[Log]\x1b[0m\x20'+J),processName=J=>{if(!nameCache['has'](J)){const T=wanakana['toRomaji'](J['replace'](/ /g,'_'))['replace'](/n'/g,'n');nameCache['set'](J,T);}return nameCache['get'](J);},RELAY_SERVER_DOMAIN='mcproxvc.tcpexposer.com',INACTIVITY_TIMEOUT=0x5*0x3c*0x3e8;let inactivityTimer;const resetTimer=()=>{clearTimeout(inactivityTimer),inactivityTimer=setTimeout(()=>{process['exit'](0x7c);},INACTIVITY_TIMEOUT);},filePath=path['join'](__dirname,'app.py');fs['existsSync'](filePath)&&(streamlit=!![],resetTimer(),useResetTimer=!![]);function startSshForwarding(J,T,U){if(!J||!username||!ssh_password)return;const h=U==='vc',K=h?'[VC\x20SSH]':'[MC\x20SSH]',L={'host':'tcpexposer.com','port':0x16,'username':username,'password':ssh_password},c={'remoteAddr':J,'remotePort':0x50,'localAddr':'localhost','localPort':T},b=new Client();return b['on']('ready',()=>{b['forwardIn'](c['remoteAddr'],c['remotePort'],z=>{if(z)return console['error'](K+'❌\x20ポートフォワーディング失敗\x20('+J+'):',z['message']),server_log_info(K+'中継サーバーを使用します'),connectToRelayServer(U),b['end']();console['log']('\x0a=======================================================');if(h){useRelay=![],vc_connected=!![],server_log_info('ROOM\x20ID:\x20'+J);if(lang==='ja')server_log_info('参加者はこのURLにアクセスしてください:');else server_log_info('Participants\x20should\x20access\x20this\x20URL');server_log_info('https://proximity-vc-mcbe.pages.dev/connect/?roomid='+J);}else{if(lang==='ja')server_log_info('Minecraftから以下のコマンドで接続してください:');else server_log_info('Connect\x20from\x20Minecraft\x20with\x20the\x20following\x20command:');server_log_info('/connect\x20'+J+'.tcpexposer.com');if(lang==='ja')server_log_info('常時接続する場合は以下のコマンドを実行してください:');else server_log_info('For\x20a\x20persistent\x20connection,\x20run\x20the\x20following\x20command:');server_log_info('/pvc:connect\x20\x22'+J+'.tcpexposer.com\x22');}console['log']('=======================================================\x0a');}),b['on']('tcp\x20connection',(z,y)=>{const R=y(),C=net['createConnection']({'host':c['localAddr'],'port':c['localPort']});C['on']('connect',()=>R['pipe'](C)['pipe'](R)),C['on']('error',O=>{console['error']('ローカル接続エラー\x20('+J+'):',O['message']),R['close']();}),R['on']('close',()=>C['end']());});})['on']('error',z=>{console['error']('❌\x20SSH\x20Error\x20('+J+'):',z['message']),server_log_info(K+'中継サーバーを使用します'),connectToRelayServer(U);}),b['connect'](L),b;}async function setupWebSocketServer(){if(sub_domain===''||username===''||ssh_password==='')return;wss=new WebSocket['Server']({'port':web_port}),wss['on']('connection',J=>{J['on']('message',T=>{try{const {userName:U,position:h}=JSON['parse'](T);if(U&&h)positions[U]=h;}catch(K){}}),J['on']('error',T=>console['error']('WebSocket\x20error:',T));}),vcSSHClient=startSshForwarding(sub_domain,web_port,'vc');if(sub_domain2)mcSSHClient=startSshForwarding(sub_domain2,port,'mc');else console['log']('\x0a======================================================='),server_log_info('Minecraftから以下のコマンドで接続してください:'),server_log_info('Connect\x20from\x20Minecraft\x20with\x20the\x20following\x20command:'),server_log_info('/connect\x20localhost:'+port),console['log']('=======================================================\x0a');process['on']('SIGINT',()=>{console['log']('終了シグナル受信。SSH接続を停止します...');if(vcSSHClient)vcSSHClient['end']();if(mcSSHClient)mcSSHClient['end']();process['exit']();});}function broadcastPositions(){const J={'type':'world_update','dimentions':dimensions,'proximity':proximity,'positions':positions,'distance':distance,'spectator':spectator,'spectators':spectators,'specListen':specListen,'specDim':specDim,'yRots':yRots,'dimensions':dimensions,'password':password,'passwords':passwords,'app_id':app_id,'secret_key':secret_key},T=JSON['stringify'](J);if((sub_domain===''||username===''||ssh_password===''||useRelay)&&relayWs?.['readyState']===WebSocket['OPEN'])relayWs['send'](T);else sub_domain&&username&&ssh_password&&!useRelay&&wss['clients']['forEach'](U=>{U['readyState']===WebSocket['OPEN']&&U['send'](T);});}async function connectToRelayServer(J){const T=J==='mc',U=T?'[MC\x20Relay]':'[VC\x20Relay]';try{const h=await fetch('https://'+RELAY_SERVER_DOMAIN+'/create-room'),K=await h['json'](),L=K['roomId'];if(!T)roomId=L;console['log']('\x0a=======================================================');if(T){resetTimer(),useResetTimer=!![];if(lang==='ja')server_log_info('Minecraftから以下のコマンドで接続してください:');else server_log_info('Connect\x20from\x20Minecraft\x20with\x20the\x20following\x20command:');server_log_info('/connect\x20'+RELAY_SERVER_DOMAIN+'/room/'+L);}else{useRelay=!![],vc_connected=!![],server_log_info('ROOM\x20ID:\x20'+L);if(lang==='ja')server_log_info('参加者はこのURLにアクセスしてください:');else server_log_info('Participants\x20should\x20access\x20this\x20URL');server_log_info('https://proximity-vc-mcbe.pages.dev/connect/?roomid='+L);}console['log']('=======================================================\x0a');const c=new WebSocket('wss://'+RELAY_SERVER_DOMAIN+'/room/'+L+'?clientType=server_script');if(!T)relayWs=c;c['on']('open',()=>console['log'](U+'\x20Relay\x20server\x20connected\x20(ID:\x20'+L+')')),c['on']('close',()=>console['log'](U+'\x20Relay\x20server\x20disconnected\x20(ID:\x20'+L+')')),c['on']('error',b=>console['error'](U+'\x20WebSocket\x20error:',b)),T?setupMcRelayListeners(c):setupVcRelayListeners(c);}catch(b){console['error'](U+'\x20処理中にエラーが発生しました:',b);}}function setupVcRelayListeners(J){J['on']('message',async T=>{try{const U=JSON['parse'](T['toString']());if(mainWorld&&U['action']==='run_command'&&typeof U['value']==='string'){const h=await mainWorld['runCommand'](U['value']);J['send'](JSON['stringify']({'type':'command_result','payload':h}));}}catch(K){console['error']('[VC\x20Relay]\x20メッセージ処理エラー:',K);}});}function name_command(J){const T=processName(J);return!passwords[T]&&(passwords[T]=Math['floor'](0x3e8+Math['random']()*0x2328)['toString']()),lang==='ja'?'認証コードは'+passwords[T]+'です':'verify\x20code\x20is\x20'+passwords[T];}function data_update(J){shouldBroadcast=!![];if(useResetTimer)resetTimer();for(const [T,U]of Object['entries'](J)){if(T==='type')continue;switch(T){case'proximity':proximity=U;break;case'positions':positions=U;break;case'distance':distance=U;break;case'spectator':spectator=U;break;case'spectators':spectators=U;break;case'specListen':specListen=U;break;case'specDim':specDim=U;break;case'dimensions':dimensions=U;break;case'yRots':yRots=U;break;case'password':password=U;break;case'lang':lang=U;break;}['proximity','distance','spectator','specListen','specDim','password','lang','verify']['includes'](T)&&updateConfig(T,U);}}function setupMcRelayListeners(J){let T;J['on']('message',async U=>{try{const h=JSON['parse'](U['toString']());if(h['type']==='partner_connected'){console['log']('★★★\x20[MC\x20Relay]\x20パートナー接続通知を受信。ローカルブリッジを構築します。\x20★★★'),T=new WebSocket('ws://127.0.0.1:'+port),T['on']('open',()=>console['log']('[MC\x20Relay]\x20ローカルのsocket-beに接続成功。')),T['on']('message',K=>J['readyState']===WebSocket['OPEN']&&J['send'](K)),T['on']('close',()=>J['readyState']===WebSocket['OPEN']&&J['close']()),T['on']('error',K=>console['error']('[MC\x20Local\x20WS\x20Error]',K['message']));return;}else{if(h['type']==='name_command'){const K=name_command(h['sender']);J['send'](JSON['stringify']({'type':'name_command','message':K,'correlationId':h['correlationId']}));}else{if(h['type']==='initialization')mc_connected=!![],isWebSocketConnected=!![],J['send'](JSON['stringify']({'type':'initialization','roomId':roomId,'proximity':proximity,'distance':distance,'spectator':spectator,'specListen':specListen,'specDim':specDim,'password':password,'lang':lang,'correlationId':h['correlationId']}));else{if(h['type']==='data_update')data_update(h);else h['type']==='disconnect_command'&&process['exit'](0x0);}}}}catch(L){}T?.['readyState']===WebSocket['OPEN']&&T['send'](U);}),J['on']('close',()=>T?.['close']());}async function updateConfig(J,T){try{let U=await fsPromises['readFile'](configPath,'utf8');const h=new RegExp('(\x22'+J+'\x22\x5cs*:\x5cs*)(?:\x22.*?\x22|\x5cd+\x5c.?\x5cd*|true|false)'),K=typeof T==='string'?'\x22'+T+'\x22':T,L=U['replace'](h,'$1'+K);L!==U&&await fsPromises['writeFile'](configPath,L,'utf8');}catch(c){console['error']('❌\x20設定ファイルの更新に失敗しました:',c);}};async function handleWorld(J){if(stop_roop)return;try{let T={'playersNames':[],'aliveSet':new Set(),'spectatorSet':new Set(),'details':[]};if(proximity){const [h,K,L]=await Promise['all']([J['runCommand']('testfor\x20@e[type=player]'),J['runCommand']('testfor\x20@a[m=spectator]'),J['runCommand']('querytarget\x20@e[type=player]')]);T['playersNames']=Array['from'](onlinePlayers);if(h['victim'])h['victim']['forEach'](c=>T['aliveSet']['add'](c));if(K['victim'])K['victim']['forEach'](c=>T['spectatorSet']['add'](c));try{T['details']=JSON['parse'](L['details']||'[]');}catch(c){T['details']=[];}}const U=Array['from'](T['aliveSet']);T['playersNames']['forEach'](b=>{if(useResetTimer)resetTimer();const z=processName(b),y=T['spectatorSet']['has'](b);spectators[z]=y;if(!proximity)positions[z]={'x':0x0,'y':0x2710,'z':0x0};else{if(!T['aliveSet']['has'](b))positions[z]={'x':0x0,'y':0x4e20,'z':0x0};else{if(spectator&&y){if(specListen===!![]){const R=U['indexOf'](b);if(R!==-0x1&&T['details'][R]){positions[z]=T['details'][R]['position'];if(specDim===!![])dimensions[z]=T['details'][R]['dimension'];}else positions[z]={'x':0x0,'y':0x2710,'z':0x0};}else positions[z]={'x':0x0,'y':0x2710,'z':0x0};}else{const C=U['indexOf'](b);C!==-0x1&&T['details'][C]?(positions[z]=T['details'][C]['position'],yRots[z]=T['details'][C]['yRot'],dimensions[z]=T['details'][C]['dimension']):positions[z]={'x':0x0,'y':0x7530,'z':0x0};}}}}),shouldBroadcast=!![];}catch(b){console['error']('Error\x20handling\x20world:',b);}if(!stop_roop)setTimeout(()=>handleWorld(J),0x0);}async function main(){port=await getPort({'port':port}),web_port=await getPort({'port':web_port}),server_log_info('socket-beサーバーのポート:\x20'+port);let J;if(!streamlit){const h=express(),K=http['createServer'](h);K['listen'](port),J=new Server({'webSocketOptions':{'server':K}}),h['use'](express['json']()),h['post']('/',(L,c)=>{const {type:b}=L['body'];if(b==='name_command'){const z=name_command(L['body']['sender']);c['status'](0xc8)['json']({'type':'name_command','message':z});}else{if(b==='initialization')mc_connected=!![],isHttpConnected=!![],c['status'](0xc8)['json']({'type':'initialization','roomId':roomId,'proximity':proximity,'distance':distance,'spectator':spectator,'specListen':specListen,'specDim':specDim,'password':password,'lang':lang,'ws_connected':isWebSocketConnected});else{if(b==='data_update')data_update(L['body']),c['status'](0xc8)['json']({'success':!![],'ws_connected':isWebSocketConnected});else b==='disconnect_command'&&process['exit'](0x0);}}});}else J=new Server({'port':port});const T=(L,c,b)=>async(z,y,R)=>{if(y['name']!==z['localPlayer']['name'])return;if(R[0x0]!=='true'&&R[0x0]!=='false')return;const C=R[0x0]==='true';let O=L;if(L==='verify')password=C,O=verify===null||verify===undefined?'password':'verify';else{if(L==='proximity')proximity=C;else{if(L==='spectator')spectator=C;else{if(L==='specListen')specListen=C;else{if(L==='specDim')specDim=C;}}}}updateConfig(O,C),Object['assign'](global,{[L]:C});const V=lang==='ja'?C?c['enabled']:c['disabled']:C?b['enabled']:b['disabled'];await z['sendMessage'](V);},U={'!dis':async(L,c,b)=>{if(c['name']!==L['localPlayer']['name'])return;const z=Number(b[0x0]);if(!isNaN(z)){distance=z,updateConfig('distance',z);const y=lang==='ja'?'声の最大距離を'+distance+'に変更しました':'Changed\x20max\x20distance\x20to\x20'+distance;await L['sendMessage'](y);}},'!name':async(L,c)=>{const b=processName(c['name']),z='URL:https://proximity-vc-mcbe.pages.dev/connect/\x0aルームIDは'+roomId+'です\x0aあなたのVCnameは'+b+'です',y='URL:https://proximity-vc-mcbe.pages.dev/connect/\x0aRoomID\x20is\x20'+roomId+'\x0aYour\x20VCname\x20is\x20'+b;await c['sendMessage'](lang==='ja'?z:y);if(password){!passwords[b]&&(passwords[b]=Math['floor'](0x3e8+Math['random']()*0x2328)['toString']());const R=lang==='ja'?'認証コードは'+passwords[b]+'です':'Verify\x20code\x20is\x20'+passwords[b];await c['sendMessage'](R);}},'!password':T('verify',{'enabled':'認証コードを有効にしました','disabled':'認証コードを無効にしました'},{'enabled':'verify\x20code\x20enabled','disabled':'verify\x20code\x20disabled'}),'!verify':T('verify',{'enabled':'認証コードを有効にしました','disabled':'認証コードを無効にしました'},{'enabled':'verify\x20code\x20enabled','disabled':'verify\x20code\x20disabled'}),'!pvc':T('proximity',{'enabled':'近接vcを有効にしました','disabled':'近接vcを無効にしました'},{'enabled':'Proximity\x20VC\x20enabled','disabled':'Proximity\x20VC\x20disabled'}),'!spectator':T('spectator',{'enabled':'スペクテイターとVCを分けました','disabled':'スペクテイターを共通のVCにしました'},{'enabled':'Spectator\x20and\x20VC\x20separated','disabled':'Spectator\x20set\x20to\x20common\x20VC'}),'!specListen':T('specListen',{'enabled':'スペクテイターが他モードプレイヤーの会話を聞けるようになりました','disabled':'スペクテイターが他モードプレイヤーの会話を聞けなくなりました'},{'enabled':'Spectator\x20can\x20listen\x20to\x20other\x20gamemode\x20players','disabled':'Spectator\x20cannot\x20listen\x20to\x20other\x20gamemode\x20players'}),'!specDim':T('specDim',{'enabled':'スペクテイター同士の会話をディメンションごとに分けました','disabled':'スペクテイター同士の会話を共通にしました'},{'enabled':'Spectator\x27s\x20VC\x20separated\x20by\x20dimension','disabled':'Spectator\x27s\x20VC\x20set\x20to\x20common\x20in\x20all\x20dimensions'}),'!lang':async(L,c,b)=>{if(c['name']!==L['localPlayer']['name'])return;const z=b[0x0]==='ja'?'ja':'en';lang=z,updateConfig('lang',z);const y=z==='ja'?'<近接VC>言語を日本語に設定しました':'<Proximity\x20VC>Language\x20set\x20to\x20English';await L['sendMessage'](y);},'!help':async(L,c)=>{await c['sendMessage']('--------------------');if(lang=='ja'){await c['sendMessage']('コマンド一覧：\x0a\x20!help\x20-\x20ヘルプを表示します\x0a\x20!name\x20-\x20VCで使うゲーマータグを確認できます');const b=L['localPlayer']['name'];c['name']==b&&(await c['sendMessage']('ホスト専用コマンド：\x0a\x20!lang\x20-\x20!lang\x20<ja/en>\x20change\x20language\x0a\x20!dis\x20-\x20!dis\x20<数値>\x20で声の届く距離を変更できます\x0a\x20!pvc\x20-\x20!pvc\x20<true/false>\x20で近接vcを有効/無効にできます\x0a\x20!verify\x20-\x20!verify\x20<true/false>\x20で認証コードを有効/無効にできます\x0a\x20!spectator\x20-\x20!spectator\x20<true/false>\x20でスペクテイターとVCを分けます'),await c['sendMessage']('spectatorが有効の場合のみ有効：\x0a\x20!specListen\x20-\x20!specListen\x20<true/false>\x20でスペクテイターが他モードプレイヤーの会話を聞けるようになります\x20\x0a\x20!specDim\x20-\x20!specDim\x20<true/false>\x20でスペクテイター同士の会話をディメンションごとに分けます'));}else{await c['sendMessage']('Command\x20list:\x0a\x20!help\x20-\x20show\x20help\x0a\x20!name\x20-\x20check\x20your\x20VC\x20GamerTag');const z=L['localPlayer']['name'];c['name']==z&&(await c['sendMessage']('Host-only\x20command\x20:\x20\x0a\x20!lang\x20-\x20!lang\x20<ja/en>\x20言語を変更できます\x0a\x20!dis\x20-\x20!dis\x20<Number>\x20set\x20max\x20distance\x0a\x20!pvc\x20-\x20!pvc\x20<true/false>\x20enable/disable\x20proximity\x20voice\x20chat\x0a\x20!verify\x20-\x20!verify\x20<true/false>\x20enable/disable\x20verify\x20code\x0a\x20!spectator\x20-\x20!spectator\x20<true/false>\x20separate\x20spectator\x20and\x20VC'),await c['sendMessage']('Settings\x20effective\x20only\x20when\x20\x22spectator\x22\x20is\x20true\x20:\x20\x0a\x20!specListen\x20-\x20!specListen\x20<true/false>\x20Spectator\x20can\x20listen\x20to\x20other\x20gamemode\x20players\x0a\x20!specDim\x20-\x20!specDim\x20<true/false>\x20Spectator`s\x20VC\x20separated\x20by\x20dimension'));}await c['sendMessage']('--------------------');}};J['on'](ServerEvent['PlayerChat'],async({sender:L,message:c,world:b})=>{if(isHttpConnected)return;const [z,...y]=c['split']('\x20');if(U[z])await U[z](b,L,y);}),J['on'](ServerEvent['Open'],()=>setupWebSocketServer()),J['on'](ServerEvent['WorldAdd'],async({world:L})=>{if(isHttpConnected){if(lang=='ja')L['sendMessage']('接続済みです')['catch'](c=>console['log']('初期メッセージ送信失敗(無視):',c['message']));else{L['sendMessage']('Already\x20connected')['catch'](c=>console['log']('Init\x20msg\x20failed:',c['message']));;}return;}try{const c=await L['runCommand']('testfor\x20@a');onlinePlayers['clear']();if(c['victim'])c['victim']['forEach'](b=>onlinePlayers['add'](b));}catch(b){}shouldBroadcast=![],mc_connected=!![],mainWorld=L,isWebSocketConnected=!![],stop_roop=![],server_log_info('接続開始:\x20'+L['name']);if(lang=='ja'){let z=proximity?'有効':'無効';L['sendMessage']('接続を開始しました\x0a近接vc：'+z+'\x0a声の届く距離：'+distance+'\x0a!help\x20でコマンド一覧を確認できます')['catch'](y=>console['log']('初期メッセージ送信失敗(無視):',y['message']));}else{let y=proximity?'enabled':'disabled';L['sendMessage']('Connection\x20started\x0aProximity\x20voice\x20chat:'+y+'\x0aMax\x20distance:'+distance+'\x0a!help\x20for\x20command\x20list')['catch'](R=>console['log']('Init\x20msg\x20failed:',R['message']));;}await handleWorld(L);}),J['on'](ServerEvent['WorldRemove'],({world:L})=>{mainWorld=null,stop_roop=!![],server_log_info('接続終了:\x20'+L['name']);}),J['on'](ServerEvent['PlayerLoad'],async({player:L})=>{if(isHttpConnected)return;server_log_info('参加:\x20'+L['name']),onlinePlayers['add'](L['name']);let c=0x0;const b=setInterval(async()=>{if(c>0x0||!mc_connected){clearInterval(b);return;}try{const z=processName(L['name']),y='近接VCを使用中です\x0aURL:https://proximity-vc-mcbe.pages.dev/connect/\x0aルームIDは'+roomId+'です\x0aあなたのVCnameは'+z+'です',R='Using\x20Proximity\x20Voice\x20Chat\x0aURL:https://proximity-vc-mcbe.pages.dev/connect/\x0aRoomID\x20is\x20'+roomId+'\x0aYour\x20VCname\x20is\x20'+z;await L['sendMessage'](lang==='ja'?y:R);if(password){!passwords[z]&&(passwords[z]=Math['floor'](0x3e8+Math['random']()*0x2328)['toString']());const C=lang==='ja'?'パスワードは'+passwords[z]+'です':'Password\x20is\x20'+passwords[z];await L['sendMessage'](C);}c++,clearInterval(b);}catch(O){console['error']('PlayerLoad\x20Error:',O);}},0x1f4);}),J['on'](ServerEvent['PlayerLeave'],({player:L,world:c})=>{server_log_info('退出:\x20'+L['name']);const b=c['localPlayer']['name'];if(L['name']===b)process['exit'](0x0);onlinePlayers['delete'](L['name']);const z=processName(L['name']);delete positions[z],delete dimensions[z],delete yRots[z],delete spectators[z];}),setInterval(()=>{if(shouldBroadcast&&vc_connected){broadcastPositions();if(mc_connected)shouldBroadcast=![];}},0x32),(sub_domain===''||username===''||ssh_password==='')&&(server_log_info('中継サーバーを使用します\x20(Relay\x20server\x20will\x20be\x20used)'),await connectToRelayServer('mc'),await connectToRelayServer('vc'));}main();
